# EC2

: 아마존에서 가장 인기 있는 서비스,(Elastic Computer Cloud = Infrastructure as a Service), AWS에서 제공하는 서비스형 인스라 스트럭처. EC2는 하나의 서비스가 아니다. 높은 수준에서 보면 많은 것을 포함하고 있다. 가상 머신을 EC2에서 임대할 수 있는데 이를 EC2 인스턴스라고 한다.

- 데이터를 가상 드라이브 또는 EBS 볼륨에 저장할 수 있고
- 일랙스틱 로드 밸런서로 로드는 분산시킬 수 있다.
- 오토 스케일링 그룹(ASG)을 통해 서비스를 확장할 수 있다.

### EC2 인스턴스 운영체제 옵션

- Linux → 가장 인기 있음
- Windows
- MacOS

CPU개수,RAM 크기, 용량 등 설정 가능 

네트워크 속도, 공용 IP 타입, 방화벽 규칙(보안 그룹) 설정 가능

![image](https://github.com/jeongye01/TIL/assets/74299317/82f9dff6-8227-421c-bcec-2342dffdf6b5)


### 부트스트래핑

: 머신이 작동될때 명령을 시작하는 것.  스크립트를 사용한다. 스크립트는 처음 시작할때 한번만 실행되고 다시 실행되지 않는다. 부팅 작업을 자동화한다. 

부팅 작업 자동화 

- 업데이트,sw 설치, 일반적인 파일을 인터넷에서 다운로드,

### EC2 종류

![image](https://github.com/jeongye01/TIL/assets/74299317/aec0e25d-9955-48cd-a623-bb798358acb0)


t2.micro → 프리티어 

### 인스턴스 유형

- 유스 케이스에 따라 최적화된 EC2 인스턴스 타입을 사용할 수 있다.
    - General Purpose : 범용 인스턴스는 웹 서버나 코드 저장소 같은 다양한 작업에 적합하다. 컴퓨팅,메모리,네트워킹 간의 균형이 잘 맞는다.
    - Compute Optimized : 컴퓨터 집약적인 작업에 최적화 되었다. 고성능 프로세서는 일부 데이터의 일괄 처리, 미디어 트랜스코딩, 고성능 웹 서버,고성능 컴퓨팅이라는 HPC 작업, 머신러닝, 게임 서버 등에 필요하다. 이들은 높은 CPU와 컴퓨팅을 요구한다. 컴퓨터 최적화의 모든 인스턴스는 C로 시작하는 이름을 가지고 있다.
    - Memory Optimized : 메모리에서 대규모 데이터셋을 처리하는 유형의 작업에 빠른 성능을 제공한다. (사용예시: 대부분 인 메모리 데이터베이스가 되는 고성능의 관계형 또는 비관계형의 데이터베이스, 일래스틱 캐시를 예로 들 수 있는 분산 웹스케일 캐시 저장소, BI(비즈니스 인텔리전스)에 최적화된 인 메모리 데이터베이스와 대규모 비정형 데이터의 실시간 처리를 실행하는 데이터 베이스). 메모리 최적화 인스턴스의 이름은 R로 시작한다.
    - Storage Optimized :  로컬 스토리지에서 대규모의 데이터셋에 엑세스할때 적합한 인스턴스. (사용예시 : OLTP, 관계형과 비관계형인 NoSQL 데이터베이스,Redis같은 메모리 데이터베이스의 캐시나 데이터 웨어하우징 어플리케이션과 분산 파일 시스템.)
    
    ![image](https://github.com/jeongye01/TIL/assets/74299317/e7da7460-6a14-4b70-9e30-632307261ecb)

    
- EC2는 아래의 명명 규칙이 있다.
    
    ![image](https://github.com/jeongye01/TIL/assets/74299317/ddabdb91-fd96-45d3-a0ad-7f03cade06a1)

    

### 보안그룹과 클래식 포트

- 보안 그룹 : EC2 인스턴스에 들어오고 나가는 트래픽을 제어. 보안 그룹 끼리 서로 참조할 수 있다
    - 예시 : 컴퓨터에서 공공 인터넷을 사용해 EC2 인스턴스에 액세스하려고 할 경우 EC2인스턴스 주변에 방화벽을 생성해야함. 그러면 보안 그룹은 규칙(인바운드 트래픽 여부. 외부에서 EC2 인스턴스로 들어오는 것이 허용되면 아웃바운드 트래픽도 수행할수 있음)을 가지게 됌

![image](https://github.com/jeongye01/TIL/assets/74299317/3f7ed030-2c67-4ed8-a550-155461580cfe)


보안 그룹은 EC2 인스턴스의 방화벽이며 포트로의 액세스를 통제하며 인증된 IP주소의 범위를 확인해 IPv4인지 IPv6인지 확인한다. 또, 외부에서 인스턴스로 들어오는 인바운드 네트워크도 통제하며 인스턴스에서 외부로 나가는 아웃바운드 네트워크도 통제한다. 

![image](https://github.com/jeongye01/TIL/assets/74299317/e933bec4-4402-4d21-9dac-4c6a7b63474f)


0.0.0.0/0 은 전체 IP를 뜻한다. 

- 여러 인스턴스에 연결할 수 있으며 보안 그룹과 인스턴스 간의 일대일 관계는 없다.
- 인스턴스에도 여러 보안 그룹을 연결할 수 있다
- EC2에서 실행하는 어플리케이션이 아니라 EC2  외부의 방화벽이다 .
- SSH 엑세스를 위해 하나의 별도 보안 그룹을 유지하느 것이 좋다. 보통 SSH 엑세스는 가장 복잡하므로 별도 보안 그룹이 잘 완료됐는지 확인해야 한다.
- 타임 아웃으로 어플리케이션에 접근할 수 없으면 보안 그룹의 문제이다.
- 하지만 연결 거부 오류가 발생하면 보안 그룹은 실행됐고 트래픽은 통과했지만 어플리케이션에 문제가 생겼거나 실행되지 않는 등 문제가 발생한 것이다.
- 기본적으로 모든 인바운드 트래픽은 차단되어 있고 모든 아웃바운드 트래픽은 허용된다.

![image](https://github.com/jeongye01/TIL/assets/74299317/55213fe7-368e-4fb6-8970-feafe0dbbff1)


자주 쓰는 포트들

- 22번 : linux에서 ec2 인스턴스 로그인, SFTP 프로토콜(upload files using SSH)
- 21번: FTP , 파일 공유 시스템에 파일을 업로드
- 80번 : http
- 443번 : https
- 3389번 : rdp 프로토콜(원격 데스크톱)

### SSH

SSH : SSH는 명령줄이나 터미널을 이용해서 원격 머신이나 서버를 제어할 수 있게 해준다

클라우드에서 실행 시 까다로운 부분 중 하나는 유지 보수나 조치를 취하기 위해 서버 내부와 연결하는 것이다. Linux 서버에서는 시큐어 셀인 SSH를 서버에 사용한다.  SSH는 명령줄 인터페이스 도구로 Mac 과 Linux에서 사용할 수 있고 Windows10 이상의 버전에서 사용할 수 있다,. windows10 이하의 버전이라면 PuTTY를 사용하면 된다. PuTTY는 SSH와 같은 개념이다.  (EC2 Instance connect는 모두 지원)

기본적으로 SSH  프로토콜을 사용해 EC2 인스턴스에 연결한다.

![image](https://github.com/jeongye01/TIL/assets/74299317/daf11f5a-bffb-4067-ba6d-cab4e3e2ceb0)


# 프라이빗 vs 퍼블릭 vs 탄력적 IP

*네트워크는 IPv4, IPv6  두종류의 IP가 있다. IPv4가 대중적임. IPv6는 사물인터넷에 많이 쓰임.

기본적으로 사설 네트워크 내의 모든 컴퓨터가 사설  IP를 사용하여 서로 통신하다가 공용 게이트웨이인 인터넷 게이트웨이를 이용하게 되면 이 인스턴스들도 공용 IP(기기가 인터넷 상에서 식별될수 있음을 의미)를 통해 인터넷 전역에 엑세스 할 수 있게됌.  각 공용 IP는 전체 웹에서 유일한 것이어야 한다.  사설 IP는 사설 네트워크 내부에서만 유일하면 된다. 

기본값으로 EC2기기는 내부 AWS 네트워크에선 사설 IP를 쓰고 World Wide Web, WWW에서는 공용 IP를 사용한다.

**탄력적 IP** : 

- 사용하지 않으면 요금이 부과된다.
- 고정된 공용 IP를 말하며 한번에 한 인스턴스에만 첨부할 수 있다.(공용 IP는 인스턴스를 껐다 킬때마다 바뀐다.)  ⇒ 한 번에 하나의 EC2 인스턴스에만 연결할 수 있다.
- 결론적으로 탄력적 IP를 사용하지 않는 것이 좋다. 대신 임의의 공용 IP를 써서 DNS이름을 할당하는 것이 좋다. 또 로드밸런서를 사용해서 공용 IP를 전혀 사용하지 않을 수도 있다.

# EC2 배치 그룹

배치그룹은 EC2 인스턴스가  AWS 인프라에 배치되는 방식을 제어하고자 할 때 쓴다. 

AWS의 하드웨어와 직접적인 상호작용을 하지는 않지만 EC2 인스턴스가 각각 어떻게 배치되기를 원하는지 AWS에 알려주는 것이다.

배치 그룹을 만들때 세가지 전략을 사용할 수 있다.

- 클러스터(cluster) 배치 그룹 : 단일 가용영역 내에서 지연 시간이 짧은 하드웨어 설정으로 인스턴스를 그룹화. 이 전략은 높은 성능을 제공하지만 위험이 높다
- 분산(spread) 배치 그룹: 인스턴스가 다른 하드웨어에 분산된다. 가용 영역별로 분산된 배치 그룹당 7개의 EC2인스턴스만 가질 수 있다는 제한사항이 있다. 크리티컬 어플리케이션이 있는경우 분산 배치 그룹을 사용한다.
- 분할(partition) 배치 그룹: 분산 배치 그룹과 비슷하게 인스턴스를 분산하려는 것. 다만 이건 여러 파티션에 인스턴스가 분할되어 있고 이 파티션은 가용영역내의 다양한 하드웨어 랙 세트에 의존한다. 인스턴스가 여전히 분산되어 있지만 다른 실패로부터 격리되지 않았다. 하지만 파티션은 다른 오류 파티션과 격리되어야 한다. 그룹당 수백개의 EC2 인스턴스를 통해 확장할 수 있고 이를 통해 Hadoop, Cassandra, Kafka 같은 어플리케이션을 실행할 수 있음

### 클러스터(cluster)

![image](https://github.com/jeongye01/TIL/assets/74299317/3dca2650-3ae6-4d07-b4d8-25d23a858554)


클러스터 배치 그룹의 경우 이는 모든 EC2 인스턴스가 동일한 랙에 있다는 것이다. 즉 동일한 하드웨어와 동일한 가용영역에 있다는 것이다. 모든 인스턴스는 동일한 하드웨어이 있다. 

지연이산이 매우 짧은 10GB 속도 정도의 네트워크를 원하기 때문에 이들을 동일한 랙에 배치한다. 

이 네트워크의 단점은 랙에 실패가 발생하면 즉 하드웨어에 실패가 발생하면 모든 EC2인스턴스가 동시에 실패한다는 것이다. 위험이 증가하는 대신 엄청난 네트워크를 얻는다. 이 네트워크로 매우 빨리 완료되어야 할 빅데이터 작업을 수행할 수 있다. 

### 분산(spread)

![image](https://github.com/jeongye01/TIL/assets/74299317/650fb11a-3dc8-4ab0-891e-75d46dfc8b8f)

분산 배치 그룹에서는 실패 위험을 최소화하려고 한다. 분산 배치그룹으로 하게 되면 모든 EC2 인스턴스가 다른 하드웨어에 위치하게 된다.  ⇒ **최대 가용성**

위 그림에서는 3개의 가용영역과 6개의 ec2가 있고 각 ec2 인스턴스는 서로 다른 하드웨어에 있다. 

단점은 이 구성에서 배치그룹의 가용영역당 7개의 인스턴스로 제한이 된다. 즉 배치 그룹의 규모에 제한이 있다. 그래서 크기가 적당하지만 너무 크지는 않은 그런 어플리케이션에서만 쓸수 있다. 

사용사례는 가용성을 그댇화하고 위험을 줄여야 하는 어플리케이션이다. 

### 분할(partition)

![image](https://github.com/jeongye01/TIL/assets/74299317/96ceb089-2d53-4d7f-833f-77e067609b49)



여러 가용영역의 파티션에 인스턴스를 분산할 수 있음. 가용영역당 최대 7개의 파티션이 있을수 있다.

이예시에서는 us-east-1a에  Partition 1과 Partition 2가 있고 각 파티션에는 많은 EC2 인스턴스가 있을 수 있다. 

각 파티션은 AWS의 랙을 나타낸다. 파티션이 많으면 인스턴스가 여러 하드웨어 랙에 분산되어 서로 랙 실패로부터 안전하다. 가용 영역당 최대 7개의 파티션이 있을수 있고 이러한 파티션은 동일한 리전의 여러 가용영역에 걸쳐 있을수 있다. 설정으로 최대 수백개 EC2 인스턴스를 얻을 수 있다. 

다른 파티션의 인스턴스와 동일한 하드웨어 물리적 랙을 공유하지 않으므로 각 파티션은 실패로부터 격리된다., 

파티션들 전반에 거렻 데이터와 서버를 퍼뜨려 두도록 파티션 인식 가능한 어플리케이션의 경우에 사용한다. 일반적인 사용사례는 HDFS Hbase Cassandra및 Apache Kafka를 사용하여 파티션을 인식하는 빅데이터 어플리케이션이 되겠다.

# ENI(탄력적 네트워크 인터페이스)

VPC의 구성요소이며 가상 네트워크 카드를 나타낸다. 

ENI는 EC2 인스턴스가 네트워크에 액세스할 수 있게 해준다. 

ENI는 EC2 인스턴스 외부에서도 사용된다. 

예를 들어 가용영역이 있고 하나의 EC2 인스턴스가 있다고 할때 기본 ENI인 Eth0에 연결되어 EC2 인스턴스 네트워크 연결을 제공한다. 각 ENI는 다음과 같은 속성을 가질 수 있다.

- 주요 사설 IPv4와 하나 이상의 보조 IPv4를 가질 수 있다.(EC2에 보조 ENI를 얼마든지 추가해도 된다. 이건 Eth1이 될거고 또다른 사설 Ipv4도 제공될것임)
- 각 ENI는 사설 IPv4 당 탄력적 IPv4를 갖거나 혹은 하나의 공용 IPv4를 가질 수 있으므로 사설 및 공용 IP가 하나씩 제공된다.
- ENI에 하나 이상의 보안 그룹을 연결할 수 있다.
- EC2 인스턴스와 독립적으로 ENI를 생성하고 즉시 연결하거나 장애조치를 위해 EC2 인스턴스에서 이동시킬 수 있다.
- ENI는 특정 가용영역 즉 AZ에 바인딩 된다. 특정 AZ에서 ENI를 생성하면 해당 AZ에만 바인딩 할 수 있다.  ⇒ 특정 AZ에 국한된다.
- 첫번째 EC2 인스턴스에서 두 번째 EC2 인스턴스로 Eth1을 옮겨서 사설 IP를 이동시킬 수 있다. → 장애조치에 유용

# EC2 Hibernate

- 온디맨드 및 예약 인스턴스를 지원한다
- EC2 인스턴스 RAM은 150GB 미만이어야 한다.

EC2 Hibernate(절전모드)

절전모드가 되면 RAM에 있던 인 메모리 상태는 그대로 보존된다. 인스턴스 부팅이 빨라진다.

운영 체제를 완전히 중지하거나 다시 시작하지 않고 그대로 멈춰뒀기 때문이다. 

EC2 절전 모드를 활성화하기 위해서는 EC2인스턴스 루트 볼륨 유형이 EBS 볼륨이어야만 한다. 그리고 반드시 암호화 되어야 한다. 

절전모드가 되고 백그라운드에서 RAM에 기록되었던 인 메모리 상태는 루트 경로의 EBS 볼륨에 기록되기 때문에 EBS 볼륨을 암호화해야 하고 볼륨 용량도 RAM을 저장하기에 충분해야 한다. 

인스턴스를 다시 실행하면 RAM을 불러와 EC2 인스턴스 메모리로 가져간다. 이렇게 하면 EC2인스턴스를 중지한 적 없는 것 처럼 된다. 

온디맨드,예약, 스팟와 같은 모든 종류의 인스턴스에 사용할 수 있다. 

사용사례

- 오래 실행되는 프로세스를 갖고 있고 중지하지 않을때
- RAM 상태를 저장하고 싶을 때
- 빠르게 재부팅을 하고 싶을 때
- 서비스 초기화가 시간을 많이 잡아먹어 서비스가 중단 없이 인스턴스를 절전 모드로 전환하고 싶을 때 등
