# **DB Migration Service**

데이터베이스를 마이그레이션하는 데 사용되는 서비스.

- onPremise ↔ Cloud
- onPremise ↔ onPremise
- Cloud ↔ Cloud

### 대표적인 제품들

- **T-UP**
- **AWS Database Migration Service (DMS)**
- **Google Cloud Database Migration Service**
- **Microsoft Azure Database Migration Service**

# T-UP

# DMS

: AWS DMS (Database Migration Service)는 데이터베이스를 마이그레이션 해주는 AWS 서비스.

On-Premise 환경의 데이터베이스에서 Cloud로 이관 혹은 그 반대로 이관할 때 용이하게 사용될 수 있다.

 각 엔드포인트가 꼭 관계형 데이터베이스여야만 하는게 아니라 데이터 웨어하우스, NoSQL 데이터베이스 등 다양한 데이터 저장소를 마이그레이션 할 수 있다.

### 기능

- Source와 Target 엔드포인트를 생성하여 N:1 통합
- Full Dump
- CDC 기능

### 사용법

Case By Case로 다양한 사용방법이 존재하지만 기본적인 사용방법은 아래와 같다.

데이터를 복제할 인스턴스를 생성하고 Source와 Target 데이터베이스를 연결해주는 엔드포인트를 생성한다. 그리고 복제 인스턴스를 통해 Relication Task를 실행하여 데이터 이관 작업을 진행한다.

### 적용사례

- banksalad
    
    **문제 사항 :** 
    
    뱅크샐러드는 쿠버네티스 기반의 MSA 아키텍쳐로 운영되는데, 각 서비스마다 RDS 클러스터 1개씩을 갖고 있었다.(Micro 단위의 서비스 분리로 상호 서비스 간의 장애 영향도를 최소화하기 위해). 이 구조가 자원 비효율성을 갖게됌.
    
    실제로 RDS 클러스터 자원량을 살펴보았을 때, 데이터베이스를 구동하기 위한 최소 생성 스팩인 t3.small로 생성 하였지만 정작 사용량은 10%를 넘지 않는 경우가 많이 발견
    
    **해결안:** 
    
    이 정도 사용량이라면 작은거 5개 쓰는것보다는 큰거 1개를 나눠서 사용하는게 효율적이지 않은가?
    
    ⇒ 각 업무 도메인 단위로 작은 여러개의 데이터베이스 클러스터를 하나의 큰 데이터베이스 클러스터로 통합.이렇게 50여개의 RDS 클러스터를 7개의 업무 도메인 클러스터링을 통해 자원 효율성을 챙기면서도 서비스의 장애가 다른 업무 도메인으로 전파되는 것은 보호 할 수 있는 제법 그럴듯한 계획이 완성
    
    **요구사항:**
    
    첫째. 클러스터링을 위해 N:1 로 통합이 되어야 한다.
    
    둘째. 최소한의 서비스 중단으로 TB 단위의 데이터베이스도 이관 되어야 한다.
    
    셋째. 실시간 변경되는 데이터까지 1개의 데이터 유실 없이 완벽하게 이관되어야 한다.
    
    ⇒ 이 모든 전제 조건을 충족할 수 있는게 바로 DMS 였습니다. Source와 Target 엔드포인트를 생성하여 N:1 통합이 가능하였으며, Full Dump와 CDC 기능을 모두 지원하기 때문에 서비스 운영중인 주간에도 통합 작업을 진행할 수 있습니다.
    
    **사용후기:**
    
    1. 생각보다 부하가 높다 : 실제 운영에 필요한 부하와 DMS를 사용하기 위한 부하가 합쳐지면서 CPU가 100%까지 치솟아 오름. 작업대상이 되는 Source와 Target의 RDS 인스턴스에 대해 평소 Peak 사용량의 2배 이상의 부하를 견딜 수 있도록 높은 인스턴스 클래스로 스팩업 후 작업을 재개할 필요가 있다.
    2. binary log 파일 보존 기한 : 지속적 복제 기능을 활용할 때 MySQL을 Source로 하는 경우 binary log 파일의 보존 기한 안에 Full Load가 완료되어야 한다는 전제 조건. ⇒ 데이터 이관 자체의 속도를 끌어올림(DMS 인스턴스 클래스를 고사양으로 변경하여 네트워크 속도 향상+안전한 Full LOB 
    Mode만을 고집하지 않고 Limited LOB Mode 사용) 
    3. 데이터 검증 : 이관 작업 자체는 서비스 운영 중에 무중단으로 진행하였지만, 꼼꼼한 검수작업을 위해서는 트래픽을 완전 차단하고 모든 데이터가 잘 옮겨졌는지 데이터 검증 과정이 필요. 
        1. 사용자가 비교적 적을 야간에 서비스 점검을 진행하여 모든 트래픽을 차단(데이터 변경 방지)
        2. Source와 Target의 전체 Row Count 비교
        3. 1,000개 단위로 Row를 Sampling하고 Source와 Target에 대한 Row Diff X 만족할 때 까지 반복
        4. 서비스의 Connection을 Target 데이터베이스로 변경한 후 Unit 테스트 진행
        5. 전체 QA 및 통합 테스트 진행
    
    **사용 효과:**
    
    RDS 클러스터 사용 비용도 작업 전 대비 1/3 로 감소하면서 많은 비용절약 효과를 얻을 수 있었고, 계획했던대로 다른 업무 도메인 단위로의 장애 전파 차단 효과도 지켜낼 수 있었습니다.
    

**참고**

https://blog.banksalad.com/tech/dms/
