인덱스 탐색 과정은 수직적 탐색과 수평적 탐색, 두 단계로 이루어 진다.

## 인덱스 튜닝 개요

### 데이터를 찾는 두 가지 방법

데이터베이스 테이블에서 데이터를 찾는 방법은 아래 두 가지다. 수십년에 걸쳐 DBMS가 발전해 왔는데도 이 두 방법에서 크게 벗어나지 못하고 있다. 

- 테이블 전체를 스캔한다.
- 인덱스를 이용한다.

테이블 전체 스캔과 관련해서는 튜닝 요소가 많지 않지만, 인덱스와 관련해서는 튜닝 요소가 매우 많고 기법도 다양하다. 그래서 인덱스는 SQL 튜닝을 공부할 때 가장 먼저 다루어야 할 주제다.

### 인덱스 튜닝의 두 가지 핵심 요소

인덱스는 큰 테이블에서 소량 데이터를 검색할때 사용한다. OLTP 시스템에서는 소량데이터를 주로 검색하므로 인덱스 튜닝이 무엇보다 중요하다.

- 인덱스 스캔 효율화 튜닝: 테이블 스캔과정에서 비효율을 줄이는 것.
- 랜덤 엑세스 최소화 튜닝 : 테이블 액세스 횟수를 줄이는 것.

인덱스 스캔 효율화 튜닝과 랜덤 액세스 최소화 튜닝 둘 다 중요하지만, 더 중요한 하나를고른다면 랜덤 엑세스 최소화 튜닝이다.

### SQL 튜닝은 랜덤 I/O 와의 전쟁

성능을 위해 DBMS가 제공하는 많은 기능이 느린 랜덤 I/O 를 극복하기 위해 개발됐다. IOT, 클러스터, 파티션에서부터 테이블 Prefetch, Batch I/O 처럼 겉으로 잘 드러나지 않는 숨은 기능까지 모두가 그렇다. 이들 기능의 본질은 랜덤 I/O를 줄이는데 있다. 

## 인덱스 구조

인덱스는 대용량 테이블에서 필요한 데이터만 빠르게 효율적으로 엑세스하기 위해 사용하는 오브젝트다. 데이터베이스에서 인덱스 없이 데이터를 검색하려면, 테이블을 처음부터 끝까지 모두 읽어야 한다. 반면, 인덱스를 이용하면 일부만 읽고 멈출 수 있다. 즉 범위 스캔(Range Scan)이 가능하다. 범위 스캔이 가능한 이유는 인덱스가 정렬돼 있기 때문이다. 

DBMS는 일반적으로 B+Tree 인덱스를 사용한다. 

리프 블록에 저장된 각 레코드는 키값 순으로 정렬돼 있을 뿐만 아니라 테이블 레코드를 가리키는 주소값, 즉 ROWID를 갖는다. 인덱스 키 값이 같으면 ROWID 순으로 정렬된다. 인덱스를 스캔하는 이유는, 검색 조건을 만족하는 소량의 데이터를 빨리 찾고 거기서 ROWID를 얻기 위해서다. ROWID는 아래와 같이 데이터 블록주소와 로우 번호로 구성되므로 이 값을 알면 테이블 레코드를 빨리 찾아갈 수 있다.

<img width="519" alt="image" src="https://github.com/jeongye01/TIL/assets/74299317/32772f9f-5772-4854-a28e-3f7737828723">



- ROWID = 데이터 블록 주소 + 로우 번호
- 데이터 블록 주소 = 데이터 파일 번호 + 블록 번호
- 블록 번호 : 데이터파일 내에서 부여한 상대적 순번
- 로우 번호 : 블록 내 순번

인덱스 탐색 과정은 수직적 탐색과 수평적 탐색으로 나눌 수 있다.

- 수직적 탐색: 인덱스 스캔 시작 지점을 찾는 과정
- 수평적 탐색: 데이터를 찾는 과정

## 인덱스 수직적 탐색

인덱스 수직적 탐색은 루트(root)블록에서부터 시작한다. 루트를 포함해 브랜치 블록에 저장된 각 인덱스 레코드는 하위 블록에 대한 주소값을 갖는다. 루트에서 시작해 리프블록까지 수직적 탐색이 가능한 이유다. 수직적 탐색과정에 찾고자 하는 값보다 크거나 같은 값을 만나면, 바로 직전 레코드(바로 직전 레코드가 없다면 LMC(Leftmost Child - 자식 노드 중 가장 왼쪽 끝에 위치한 블록)로 간다)가 가리키는 하위 블록으로 이동한다. 

## 인덱스 수평적 탐색

인덱스에서 본격적으로 데이터를 찾는 과정이다. 인덱스 리프블록끼리는 서로 앞뒤 블록에 대한 주소값을 갖는다. 양방향 연결 리스트 구조다. 

## 결합 인덱스 구조와 탐색

인덱스 선두 컬럼을 모두 “=” 조건으로 검색할 때는 어느 컬럼을 인덱스 앞쪽에 두든 블록 I/O 개수가 같으므로 성능도 똑같다. 예를 들어 인덱스를 고객명+성별로 구성하든 성별+고객명으로 구성하든 읽는 인덱스 블록 개수가 똑같다는 것이다. 

B+Tree인덱스는 엑셀처럼 평면 구조가 아니다. 

## Balanced의 의미

Balanced는 어떤 값으로 탐색하더라도 인덱스 루트에서 리프 블록에 도달하기 까지 읽는 블록수가 같음을 의미한다.
