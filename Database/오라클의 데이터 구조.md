# 중요한 키워드

- 테이블스페이스(tablespace)
- 세그먼트(segment)
- 익스텐트(extent)
- 블록(block)
- 데이터 파일(datafile)

# 가변 길이 데이터 처리

다음의 세 가지를 구현할 수 있는 구조가 필요함.

- 관리 및 I/O 효율을 고려해 공간을 어느 정도의 크기로 뭉쳐서 할당한다.
- 데이터 변경에 필요한 공간을 확보한다.
- 비어 있는 공간을 관리한다.

<img width="492" alt="image" src="https://github.com/jeongye01/TIL/assets/74299317/8f97feba-d2a0-437b-b93e-bfbc76f0e613">


# 오라클 데이터 구조

오라클의 데이터 구조는 크게 물리 구조, 논리 구조로 나눌 수 있다. 

- 물리 구조 →  물리적 단위는 파일을 의미 (데이터 파일 등의 OS에서 보이는 구조)
- 논리 구조 → 데이터블록 → 익스텐트 → 세그먼트 →테이블스페이스 (OS에서는 식별할 수 없는 오라클 내부의 구조)

<img width="491" alt="image" src="https://github.com/jeongye01/TIL/assets/74299317/332a6d75-5334-4c82-b459-355468488ee5">


테이블이나 인덱스는 익스텐트로 구성되어 있고, 익스텐트는 블록으로 구성되어 있음. 

# 데이터 파일과 테이블의 관계

데이터 파일 → OS에서 보이는 물리 구조.

테이블 → 논리적인 구조. (OS에서 보이지 않음)

<img width="480" alt="image" src="https://github.com/jeongye01/TIL/assets/74299317/ff8756e9-722d-4ac5-9a74-9b75a3052ab5">


- 익스텐트 : 연속된 블록의 집합. 익스텐트를 통해 각 블록의 위치가 아니라 각 익스텐트의 첫 위치와 블록의 개수 만으로 데이터를 관리 할 수 있으며, 관리 정보도 줄일 수 있음. 또한 데이터를 한 번에 읽어 올 수 있으므로 테이블의 풀 스캔 성능을 향상할 수 있음
- 세그먼트 : 익스텐트의 집합.

<img width="675" alt="image" src="https://github.com/jeongye01/TIL/assets/74299317/916123e4-7915-4baf-970b-7a9e09a5a294">


<img width="473" alt="image" src="https://github.com/jeongye01/TIL/assets/74299317/c630a8d4-acc6-45ef-9a39-ab77228f7049">


# 데이터 구조

### 세그먼트

세그먼트- > 익스텐트의 집합 

테이블이나 인덱스 같은 세그먼트는 사용자의 조작대상이다. 

### 세그먼트 분류
1. **데이터 세그먼트 (Data Segments)**: 특정 테이블에 저장된 데이터를 포함합니다. 각 테이블은 자체 데이터 세그먼트를 갖습니다.
2. **인덱스 세그먼트 (Index Segments)**: 데이터베이스 인덱스에 대한 정보를 저장합니다. 각 인덱스는 자체 인덱스 세그먼트를 가지며, 이는 테이블의 데이터에 대한 빠른 검색을 지원합니다.
3. **롤백 세그먼트 (Rollback Segments)**: 트랜잭션이 실패하거나 취소될 때 원래 상태로 데이터를 복원하는데 필요한 정보를 저장합니다. 롤백 세그먼트는 오라클에서 트랜잭션의 일관성을 유지하는 데 중요한 역할을 합니다.
4. **임시 세그먼트 (Temporary Segments)**: 정렬이나 조인과 같은 데이터베이스 연산 중 생성되어 사용되는 세그먼트로, 작업이 완료되면 이 세그먼트는 다시 시스템에 반환됩니다.
5. **LOB 세그먼트 (Large Object Segments)**: 대용량 데이터 객체 (예: CLOB, BLOB)를 저장하는 데 사용됩니다. LOB 세그먼트는 이러한 대용량 데이터를 효율적으로 관리하기 위해 설계되었습니다.


### 테이블 스페이스

테이블스페이스도 오라클 내부의 구조이다. 세그먼트를 분류해서 보관하기 위한 상자이다. 한 개 이상의 데이터 파일로 구성되어 있다.

테이블 스페이스에는 오라클이 데이터베이스를 관리하기 위해 사용하는 테이블스페이스와 사용자가 사용하는 테이블 스페이스 등 몇 가지 종류가 존재한다. 

### 블록 안의 공간

오라클은 블록 안에 데이터 변경에 대비한 공간을 남겨 둔다. 데이터가 계속 삭제되엎 블록안의 공간이 늘어나면 다시 해당 블록으로 데이터를 입력한다.

어떤 블록에 공간이 남아 있는지를 빠르게 파악하기 위해 빈 블록을 세그먼트 단위로 관리한다. 세그먼트 안에 공간이 모자란 상황이 오면 세그먼트에 새로운 익스텐트를 추가하고 빈 블록을 늘린다.

<img width="482" alt="image" src="https://github.com/jeongye01/TIL/assets/74299317/2731b892-1524-4bbd-9651-21c59b0759c2">

### ROWID

오라클에서는 데이터 로우의 주소를 ‘ROWID’라고 부른다. ‘ROWID’는 데이터 파일의 번호, 데이터 파일 안의 블록 번호, 블록안에 로우 번호로 구성되어 있다.

# 실제 흐름을 따라 각 동작 정리

공간을 할당하는 것과 비어 있는 관리하는 동작 정리

1. 데이터 베이스의 생성
    1. SYSTEM 테이블스페이스를 시작으로 몇 가지 테이블스페이스가 생성된다.
2. 사용자용 테이블스페이스의 생성
    1. 사용자용 테이블스페이스를 생성하는 것은 데이터베이스를 생성할 때 같이 해도 상관없다.
    2. 이 시점에서 테이블스페이스는 비어 있는 공간을 가지게 된다. 
3. 테이블을 테이블스페이스에 생성
    1. 내부가 비어있는 상태로 익스텐트가 생성
    2. 데이터 입력시(INSERT) 익스텐트의 비어 있는 블록에 데이터를 입력한다.
    3. ‘PCTFREE’라는 임계치에 도달하면 해당 블록에 입력하는 것을 멈추고 이 블록에는 공간이 없다고 인식한다.
    4. 그리고 다음에는 비어 있는 블록에 데이터를 입력한다.
    5. 익스텐트가 가득 차게 되면 테이블스페이스가 가지고 있는 빈 공간을 사용해 새로운 익스텐트를 테이블에 할당하고 데이터를 입력할 수 있게 한다. 
    6. 데이터를 삭제하여 PCTUSED 임계지차 낮아지면 다시 이 블록은 비어 있다라고 인식하게 된다.
    7. 테이블이나 인덱스가 DROP되면 익스텐트 안의 데이터는 불필요 하므로 테이블 스페이스의 빈 공간으로 돌아간다. 
    

# 테이블스페이스가 가득 찰 경우

이때는 익스텐트가 할당하지 못하며 에러가 발생한다. 따라서 운영 환경에서 테이블스페이스가 가진 여유 공간을 모니터링하는 것은 매우 중요하다. 

관리용으로 사용하는 테이블스페이스(SYSTEM 테이블스페이스)에는 사용자용의 세그먼트를생성해서는 안된다. 잘못해서 SYSTEM 테이블스페이스가 가득차게 되면 데이터베이스 전체에 영향을 준다.
