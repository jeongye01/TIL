# 아키텍처

- MySQL 엔진: SQL 문장을 분석하거나 최적화
    - 커넥션 핸들러
    - SQL 파서
    - 전처리기
    - 옵티마이저
- 스토리지 엔진 : 실제 데이터를 디스크 스토리지에 저장하거나 디스크 스토리지부터 데이터를 읽어옴 (데이터 읽기/쓰기)
- 핸들러 API : 스토리지 엔진과 MySQL 엔진이 데이터를 주고 받게 함. MySQL엔진이 각 스토리지 엔진에게 데이터를 읽어오거나 저장하도록 명령하려면 핸들러를 통해야 함.

# MySQL 스레딩 구조

MySQL 서버는 프로세스 기반이 아니라 스레드 기반으로 작동한다. 

- Foreground 스레드
    - 최소한 MySQL 서버에 접속된 클라이언트의 수만큼 존재
    - 주로 각 클라이언트 사용자가 요청하는 쿼리 문장을 처리
    - 데이터를 데이터 버퍼나 캐시로부터 가져오며, 버퍼나 캐시에 없는 경우에는 직접 디스크의 데이터나 인텍스 파일로부터 데이터를 읽어와서 작업을 처리한다,
- Background 스레드
    - Insert Buffer 병합 스레드
    - 로그를 디스크로 기록하는 스레드
    - InnoDB 버퍼 풀의 데이터를 디스크에 기록하는 스레드
    - 데이터를 버퍼로 읽어 오는 스레드
    - 잠금이나 데드락을 모니터링하는 스레드

# 메모리 할당 및 사용 구조

### 메모리 공간

- 글로벌 메모리 영역
    - 모든 스레드에 의해 공유
    - MySQL 서버가 시작되면서 운영체제로부터 할당
    - 클라이언트 스레드 수와 무관하게 하나의 메모리 공간만 할당
    - 대표적인 글로벌 메모리 영역
        - 테이블 캐시
        - InnoDB 버퍼 풀
        - InnoDB 어댑티브 해시 인덱스
        - InnoDB 리두 로그 버퍼
- 로컬 메모리 영역
    - MySQL 서버상에서 존재하는 클라이언트 스레드가 쿼리를 처리하는 데 사용하는 영역
    - 클라이언트가 MySQL 서버에 접속하면 MySQL 서버에서는 클라이언트 커넥션으로부터 요청을 처리하기 위해 스레드를 하나씩 할당
    - 공유되지 않음.
    - 각 쿼리의 용도별로 필요할 때만 공간이 할당되고 필요하지 않은 경우에는 메모리 공간을 할당하지 않을 수 있음
    - 대표적인 로컬 메모리 영역
        - 정렬 버퍼(Sort buffer)
        - 조인 버퍼
        - 바이너리 로그 캐시
        - 네트워크 버퍼

# 플러그인 스토리지 엔진 모델

- MySQL 서버에서는 스토리지 엔진(InnoDB,MyISAM)뿐만 아니라 다양한 기능을 플러그인 형태로 지원한다.
- 인증이나 전문 검색 파서 또는 쿼리 재작성과 같은 플러그인들이 있다.
- 단점
    - 오직 MySQL 서버와 인터페이스 할 수 있고, 플러그인끼리는 통신할 수 없음
    - MySQL 서버의 변수나 함수를 직접 호출하기 때문에 안전하지 않음(캡슐화 안됨)
    - 상호 의존 관계를 설정할 수 없어서 초기화가 어려움

# 컴포넌트

- MySQL 8.0 부터는 기존의 플러그인 아키텍처를 대체하기 위해 컴포넌트 아키텍처가 지원된다.

# 쿼리 실행 구조

<img width="424" height="249" alt="image" src="https://github.com/user-attachments/assets/7fd08407-692b-45ce-bc96-3af6ae1e2b65" />


- 쿼리 파서 : 사용자 요청으로 들어온 쿼리 문장을 토큰으로 분리해 트리 형태의 구조로 만들어 내는 작업
- 전처리기 : 파서 과정에서 만들어진 파서 트리를 기반으로 쿼리 문장에 구조적인 문제점이 있는지 확인. 실제 존재 하지 않거나 권한상 사용할 수 없는 개체의 토큰은 이 단계에서 걸러진다.
- 옵티마이저: 사용자의 요청으로 들어온 쿼리 문장을 저렴한 비용으로 가장 빠르게 처리할지를 결정
- 실행 엔진: 만들어진 계획대로 각 핸들러에게 요청해서 받은 결과를 또 다른 핸들러 요청의 입력으로 연결
- 핸들러(스토리지 엔진) : 스토리지 엔진을 의미

# 쿼리 캐시

- SQL의 실행 결과를 메모리에 캐시하고 동일 SQL 쿼리가 실행되면 테이블을 읽지 않고 즉시 결과를 반환
- MySQL 서버에서 쿼리 캐시는 제거 됨.
    - 데이터 변경은 거의 없고 읽기만 하는 서비스에서는 매우 훌륭한 기능이지만 실제로 그런 경우는 거의 없고 수많은 버그와 성능 저하의 원인이므로
